import React, { useState, useEffect, useCallback } from 'react';
import { db } from '@/lib/firebase';
import { collection, getDocs, query, where, addDoc, updateDoc, doc, deleteDoc } from 'firebase/firestore';
import { updateEmployeeMonthlyStats } from '@/utils/monthlyStatsCache';
import { cachedQuery, getCacheKey } from '@/utils/simpleCache';
import { PayrollCalculator } from '@/utils/PayrollCalculator';

// ì£¼íœ´ìˆ˜ë‹¹ ê³„ì‚° íƒ€ì…
type WeeklyHolidayInput = {
  hourlyWage: number;
  weeklyContractHours: number;
  weeklyWorkdays: number;
  workedAllScheduledDays: boolean;
  isFirstWeek: boolean;
  carryoverHoursPrevWeek?: number;
  requirePrevWeekAttendance?: boolean;
  prevWeekWorkedAll?: boolean;
};

// ì£¼íœ´ìˆ˜ë‹¹ ê³„ì‚° í•¨ìˆ˜
function calcWeeklyHolidayPay(i: WeeklyHolidayInput) {
  if (i.hourlyWage <= 0 || i.weeklyContractHours <= 0 || i.weeklyWorkdays <= 0) {
    return { eligible: false, hours: 0, pay: 0 };
  }

  const carry = i.isFirstWeek ? (i.carryoverHoursPrevWeek ?? 0) : 0;
  const hoursForEligibility = i.weeklyContractHours + carry;

  const attendanceOK =
    i.workedAllScheduledDays &&
    (!i.requirePrevWeekAttendance || (i.prevWeekWorkedAll ?? true));

  const eligible = hoursForEligibility >= 15 && attendanceOK;
  if (!eligible) return { eligible, hours: 0, pay: 0 };

  const weeklyHolidayHours = i.weeklyContractHours / i.weeklyWorkdays;
  const pay = Math.round(weeklyHolidayHours * i.hourlyWage);

  return { eligible, hours: weeklyHolidayHours, pay };
}

interface Employee {
  id: string;
  name: string;
  branchIds: string[];
  employmentType: string;
  salaryType?: 'hourly' | 'monthly' | 'ì‹œê¸‰' | 'ì›”ê¸‰';
  hourlyWage?: number;
  monthlySalary?: number;
  probationStartDate?: Date | { toDate: () => Date };
  probationEndDate?: Date | { toDate: () => Date };
  probationStart?: Date | { toDate: () => Date };
  probationEnd?: Date | { toDate: () => Date };
  includesWeeklyHolidayInWage?: boolean;
  weeklyContractHours?: number;
  weeklyWorkdays?: number;
}

interface Branch {
  id: string;
  name: string;
}

interface WeeklySchedule {
  id: string;
  employeeId: string;
  branchId: string;
  branchName: string;
  month: string;
  weekStart: Date;
  weekEnd: Date;
  schedules: Record<string, unknown>[];
  actualWorkHours: number;
  breakTime: number;
  date?: string | Date;
  startDate?: string | Date;
  createdAt?: Date | { toDate: () => Date };
  workDate?: string | Date;
  scheduleDate?: string | Date;
  weekStartDate?: string | Date;
  weeklyContractHours?: number;
  weeklyWorkdays?: number;
  workedAllScheduledDays?: boolean;
  [key: string]: unknown;
}

interface PayrollCalculation {
  employeeId: string;
  employeeName: string;
  employmentType: string;
  salaryType?: string;
  hourlyWage?: number;
  monthlySalary?: number;
  totalWorkHours: number;
  totalBreakTime: number;
  actualWorkHours: number;
  grossPay: number;
  deductions: {
    insurance: number;
    tax: number;
    total: number;
    // 4ëŒ€ë³´í—˜ ìƒì„¸ (ê·¼ë¡œì†Œë“ìë§Œ)
    insuranceDetails?: {
      nationalPension: number;
      healthInsurance: number;
      longTermCare: number;
      employmentInsurance: number;
    };
    // ì†Œë“ì„¸ ìƒì„¸ (ê·¼ë¡œì†Œë“ìë§Œ)
    taxDetails?: {
      incomeTax: number;
      localIncomeTax: number;
    };
  };
  netPay: number;
  branches: {
    branchId: string;
    branchName: string;
    workHours: number;
  }[];
  probationHours?: number;
  regularHours?: number;
  probationPay?: number;
  regularPay?: number;
  weeklyHolidayPay?: number;
  weeklyHolidayHours?: number;
  includesWeeklyHolidayInWage?: boolean;
  weeklyHolidayDetails?: Array<{
    weekStart: string;
    weekEnd: string;
    hours: number;
    pay: number;
    eligible: boolean;
    reason?: string;
  }>;
  // ë¬´ê¸‰íœ´ê°€ ê´€ë ¨ (ê·¼ë¡œì†Œë“ì+ì›”ê¸‰ì œ ì „ìš©)
  unpaidLeaveDays?: number; // ë¬´ê¸‰íœ´ê°€ ì¼ìˆ˜
  unpaidLeaveDeduction?: number; // ë¬´ê¸‰íœ´ê°€ ì°¨ê°ì•¡
}

interface PayrollCalculationProps {
  userBranch?: string;
  isManager: boolean;
  selectedMonth?: string;
  selectedEmployeeId?: string;
  onPayrollStatusChange?: () => void;
}

const PayrollCalculation: React.FC<PayrollCalculationProps> = ({ userBranch, isManager, selectedMonth: propSelectedMonth, selectedEmployeeId: propSelectedEmployeeId, onPayrollStatusChange }) => {
  const [selectedMonth, setSelectedMonth] = useState<string>(propSelectedMonth || '');
  const [selectedBranchId, setSelectedBranchId] = useState<string>('');
  const [selectedEmployeeId, setSelectedEmployeeId] = useState<string>(propSelectedEmployeeId || '');
  const [employees, setEmployees] = useState<Employee[]>([]);
  const [branches, setBranches] = useState<Branch[]>([]);
  const [weeklySchedules, setWeeklySchedules] = useState<WeeklySchedule[]>([]);
  const [payrollCalculations, setPayrollCalculations] = useState<PayrollCalculation[]>([]);
  const [loading, setLoading] = useState(false);
  const [confirming, setConfirming] = useState(false);
  const [memo, setMemo] = useState<string>('');
  const [savingMemo, setSavingMemo] = useState(false);
  const [noScheduleData, setNoScheduleData] = useState(false);
  const [employeeMemos, setEmployeeMemos] = useState<{[employeeId: string]: string}>({});
  const [isPayrollConfirmed, setIsPayrollConfirmed] = useState(false);

  // ğŸ”¥ ìµœì í™”: ì§€ì  ë¡œë“œ (ìºì‹± ì ìš©)
  const loadBranches = useCallback(async () => {
    try {
      console.log('ğŸ”¥ PayrollCalculation - loadBranches ì‹œì‘');
      const branchesData = await cachedQuery(
        getCacheKey.branches(),
        async () => {
          const branchesSnapshot = await getDocs(collection(db, 'branches'));
          return branchesSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          })) as Branch[];
        },
        15 * 60 * 1000 // 15ë¶„ ìºì‹œ (ì§€ì ì€ ìì£¼ ë³€ê²½ë˜ì§€ ì•ŠìŒ)
      );
      
      console.log('ğŸ”¥ PayrollCalculation - ì§€ì  ë°ì´í„° ë¡œë“œë¨:', branchesData.length, 'ê°œ');
      
      if (isManager) {
        setBranches(branchesData);
        console.log('ğŸ”¥ PayrollCalculation - ë§¤ë‹ˆì €: ëª¨ë“  ì§€ì  ì„¤ì •ë¨');
      } else if (userBranch) {
        const userBranchData = branchesData.filter(branch => branch.id === userBranch);
        setBranches(userBranchData);
        console.log('ğŸ”¥ PayrollCalculation - ì¼ë°˜ì‚¬ìš©ì: ì‚¬ìš©ì ì§€ì ë§Œ ì„¤ì •ë¨', userBranchData.length, 'ê°œ');
      }
    } catch (error) {
      console.error('ì§€ì  ë¡œë“œ ì‹¤íŒ¨:', error);
    }
  }, [isManager, userBranch]);

  // ğŸ”¥ ìµœì í™”: ì§ì› ë¡œë“œ (ìºì‹± ì ìš©)
  const loadEmployees = useCallback(async () => {
    try {
      console.log('PayrollCalculation - employees ì»¬ë ‰ì…˜ ì¡°íšŒ ì‹œì‘');
      
      const employeesData = await cachedQuery(
        getCacheKey.employees(),
        async () => {
          const employeesSnapshot = await getDocs(collection(db, 'employees'));
          console.log('PayrollCalculation - employees ì»¬ë ‰ì…˜ ì¡°íšŒ ì™„ë£Œ:', employeesSnapshot.docs.length, 'ê±´');
          return employeesSnapshot.docs.map(doc => {
            const data = doc.data();
            return {
              id: doc.id,
              ...data,
              // Timestampë¥¼ Dateë¡œ ë³€í™˜
              probationStartDate: data.probationStartDate?.toDate ? data.probationStartDate.toDate() : data.probationStartDate,
              probationEndDate: data.probationEndDate?.toDate ? data.probationEndDate.toDate() : data.probationEndDate
            };
          }) as Employee[];
        },
        10 * 60 * 1000 // 10ë¶„ ìºì‹œ
      );
      
      const ìœ ì€ì„œí…ŒìŠ¤íŠ¸ì§ì› = employeesData.find(emp => emp.name === 'ìœ ì€ì„œí…ŒìŠ¤íŠ¸');
      console.log('PayrollCalculation - ì§ì› ì›ë³¸ ë°ì´í„° í™•ì¸:', ìœ ì€ì„œí…ŒìŠ¤íŠ¸ì§ì›);
      console.log('PayrollCalculation - ìœ ì€ì„œí…ŒìŠ¤íŠ¸ ìˆ˜ìŠµê¸°ê°„ ì •ë³´:', {
        probationStartDate: ìœ ì€ì„œí…ŒìŠ¤íŠ¸ì§ì›?.probationStartDate,
        probationEndDate: ìœ ì€ì„œí…ŒìŠ¤íŠ¸ì§ì›?.probationEndDate,
        probationStart: ìœ ì€ì„œí…ŒìŠ¤íŠ¸ì§ì›?.probationStart,
        probationEnd: ìœ ì€ì„œí…ŒìŠ¤íŠ¸ì§ì›?.probationEnd
      });
      
      // ğŸ”¥ ë„ì—‰ ì§ì› ìˆ˜ìŠµê¸°ê°„ ì •ë³´ í™•ì¸
      const ë„ì—‰ì§ì› = employeesData.find(emp => emp.name === 'ë„ì—‰');
      console.log('ğŸ”¥ğŸ”¥ğŸ”¥ ë„ì—‰ ì§ì› ë°ì´í„° í™•ì¸:', ë„ì—‰ì§ì›);
      console.log('ğŸ”¥ğŸ”¥ğŸ”¥ ë„ì—‰ ìˆ˜ìŠµê¸°ê°„ ì •ë³´:', {
        probationStartDate: ë„ì—‰ì§ì›?.probationStartDate,
        probationEndDate: ë„ì—‰ì§ì›?.probationEndDate,
        probationStartDateType: typeof ë„ì—‰ì§ì›?.probationStartDate,
        probationEndDateType: typeof ë„ì—‰ì§ì›?.probationEndDate
      });

      // ê° ì§ì›ì˜ ìµœì‹  ê³„ì•½ì„œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const employeesWithContracts = await Promise.all(
        employeesData.map(async (employee) => {
          try {
            const contractsQuery = query(
              collection(db, 'employmentContracts'),
              where('employeeId', '==', employee.id)
            );
            const contractsSnapshot = await getDocs(contractsQuery);
            
            if (!contractsSnapshot.empty) {
              // ğŸ”¥ ë°±ìŠ¹ìš° ê³„ì•½ì„œ ê°œìˆ˜ í™•ì¸
              if (employee.name === 'ë°±ìŠ¹ìš°') {
                console.log('ğŸ”¥ğŸ”¥ğŸ”¥ ë°±ìŠ¹ìš° ê³„ì•½ì„œ ê°œìˆ˜:', contractsSnapshot.docs.length);
                contractsSnapshot.docs.forEach((doc, idx) => {
                  console.log(`ğŸ”¥ ë°±ìŠ¹ìš° ê³„ì•½ì„œ ${idx + 1}:`, doc.data());
                });
              }
              
              // ìµœì‹  ê³„ì•½ì„œ ì°¾ê¸° (createdAt ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬)
              const contracts = contractsSnapshot.docs
                .map(doc => ({ id: doc.id, ...doc.data() }) as { id: string; createdAt?: Date | { toDate: () => Date } | string; [key: string]: unknown })
                .sort((a, b) => {
                  const dateA = a.createdAt ? new Date(a.createdAt.toString()).getTime() : 0;
                  const dateB = b.createdAt ? new Date(b.createdAt.toString()).getTime() : 0;
                  return dateB - dateA;
                });
              const contract = contracts[0] as { [key: string]: unknown; employmentType?: string; salaryType?: string; hourlyWage?: number; monthlySalary?: number; salaryAmount?: number; probationStartDate?: Date | { toDate: () => Date }; probationEndDate?: Date | { toDate: () => Date } };
              
            console.log(`ì§ì› ${employee.name} ê³„ì•½ì„œ ì •ë³´:`, {
              employeeId: employee.id,
              contractEmploymentType: contract.employmentType,
              contractSalaryType: contract.salaryType,
              contractSalaryAmount: contract.salaryAmount,
              contractHourlyWage: contract.hourlyWage,
              contractMonthlySalary: contract.monthlySalary,
              probationStartDate: contract.probationStartDate,
              probationEndDate: contract.probationEndDate,
              probationStartType: typeof contract.probationStartDate,
              probationEndType: typeof contract.probationEndDate
            });
            
            console.log(`ì§ì› ${employee.name} ê³„ì•½ì„œ ì›ë³¸ ë°ì´í„°:`, contract);
            
            // ğŸ”¥ ë°±ìŠ¹ìš° ê³„ì•½ì„œ ìƒì„¸ ë””ë²„ê¹…
            if (employee.name === 'ë°±ìŠ¹ìš°') {
              console.log('ğŸ”¥ğŸ”¥ğŸ”¥ ë°±ìŠ¹ìš° ê³„ì•½ì„œ ìƒì„¸:', {
                salaryType: contract.salaryType,
                salaryAmount: contract.salaryAmount,
                hourlyWage: contract.hourlyWage,
                monthlySalary: contract.monthlySalary,
                allContractKeys: Object.keys(contract),
                contract: contract
              });
            }
              
              return {
                ...employee,
                employmentType: (contract.employmentType as string) || 'ë¡œë“œì‹¤íŒ¨',
                salaryType: (contract.salaryType === 'hourly' ? 'ì‹œê¸‰' : 
                           contract.salaryType === 'monthly' ? 'ì›”ê¸‰' : 
                           contract.salaryType as string || 'ë¡œë“œì‹¤íŒ¨') as 'ì‹œê¸‰' | 'ì›”ê¸‰' | 'hourly' | 'monthly',
                hourlyWage: contract.salaryType === 'hourly' ? (contract.salaryAmount as number) : (contract.salaryType === 'monthly' ? 0 : employee.hourlyWage),
                monthlySalary: contract.salaryType === 'monthly' ? (contract.salaryAmount as number) : (contract.salaryType === 'hourly' ? 0 : employee.monthlySalary),
                // ìˆ˜ìŠµê¸°ê°„ ì •ë³´ëŠ” employees ì»¬ë ‰ì…˜ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
                probationStartDate: employee.probationStartDate || contract.probationStartDate,
                probationEndDate: employee.probationEndDate || contract.probationEndDate,
                // ì£¼íœ´ìˆ˜ë‹¹ í¬í•¨ ì—¬ë¶€ (ê³„ì•½ì„œì—ì„œ ê°€ì ¸ì˜¤ê¸°)
                includesWeeklyHolidayInWage: contract.includeHolidayAllowance as boolean || false
              };
            }
            
            console.log(`ì§ì› ${employee.name} ê³„ì•½ì„œ ì—†ìŒ - ê¸°ì¡´ ì •ë³´ ì‚¬ìš©:`, {
              employeeId: employee.id,
              originalEmploymentType: employee.employmentType,
              originalSalaryType: employee.salaryType,
              originalHourlyWage: employee.hourlyWage,
              originalMonthlySalary: employee.monthlySalary,
              originalProbationStartDate: employee.probationStartDate,
              originalProbationEndDate: employee.probationEndDate
            });
            
            return {
              ...employee,
              // ê³„ì•½ì„œê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ employee ì •ë³´ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ê¸°ë³¸ê°’ ì„¤ì •í•˜ì§€ ì•ŠìŒ)
              employmentType: employee.employmentType || 'ì •ë³´ì—†ìŒ',
              salaryType: employee.salaryType,
              hourlyWage: employee.hourlyWage,
              monthlySalary: employee.monthlySalary
            };
          } catch (error) {
            console.error(`ì§ì› ${employee.name} ê³„ì•½ì„œ ë¡œë“œ ì‹¤íŒ¨:`, error);
            return {
              ...employee,
              // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ê¸°ë³¸ê°’ ì„¤ì •í•˜ì§€ ì•ŠìŒ
              employmentType: employee.employmentType || 'ì •ë³´ì—†ìŒ',
              salaryType: employee.salaryType,
              hourlyWage: employee.hourlyWage,
              monthlySalary: employee.monthlySalary
            };
          }
        })
      );

      setEmployees(employeesWithContracts);
    } catch (error) {
      console.error('ì§ì› ë¡œë“œ ì‹¤íŒ¨:', error);
    }
  }, []);

  // ğŸ”¥ ìµœì í™”: ì§ì› ë¡œë“œëŠ” ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ í•œ ë²ˆë§Œ

  // ì£¼ê°„ ìŠ¤ì¼€ì¤„ ë¡œë“œ
  const loadWeeklySchedules = useCallback(async () => {
    if (!selectedMonth || !selectedBranchId || !selectedEmployeeId) {
      return;
    }

    try {
      setLoading(true);
      console.log('PayrollCalculation - ì£¼ê°„ ìŠ¤ì¼€ì¤„ ë¡œë“œ ì‹œì‘...');
      
      // ğŸ”¥ workTimeComparisonResultsì—ì„œ ë°ì´í„° ì¡°íšŒ
      const schedulesQuery = query(
        collection(db, 'workTimeComparisonResults'),
        where('month', '==', selectedMonth),
        where('employeeId', '==', selectedEmployeeId)
      );
      
      const schedulesSnapshot = await getDocs(schedulesQuery);
      console.log('PayrollCalculation - ê·¼ë¬´ì‹œê°„ë¹„êµ ê²°ê³¼ ì¿¼ë¦¬ (ëª¨ë“  ì§€ì ):', schedulesSnapshot.docs.length, 'ê±´');
      
      // ì¿¼ë¦¬ ì¡°ê±´ í™•ì¸
      console.log('PayrollCalculation - ì¿¼ë¦¬ ì¡°ê±´:', {
        month: selectedMonth,
        employeeId: selectedEmployeeId,
        note: 'ì§€ì  í•„í„° ì œê±° - ëª¨ë“  ì§€ì  ë°ì´í„° ì¡°íšŒ'
      });
      
      // ëª¨ë“  ì£¼ê°„ ìŠ¤ì¼€ì¤„ ë°ì´í„° í™•ì¸
      const allSchedulesQuery = query(
        collection(db, 'weeklySchedules'),
        where('employeeId', '==', selectedEmployeeId)
      );
      const allSchedulesSnapshot = await getDocs(allSchedulesQuery);
      console.log('PayrollCalculation - í•´ë‹¹ ì§ì›ì˜ ëª¨ë“  ì£¼ê°„ ìŠ¤ì¼€ì¤„:', allSchedulesSnapshot.docs.length, 'ê±´');
      
      if (allSchedulesSnapshot.docs.length > 0) {
        console.log('PayrollCalculation - ëª¨ë“  ì£¼ê°„ ìŠ¤ì¼€ì¤„ ë°ì´í„°:', allSchedulesSnapshot.docs.map(doc => ({
          id: doc.id,
          branchId: doc.data().branchId,
          month: doc.data().month,
          employeeId: doc.data().employeeId
        })));
      }
      
      // ì „ì²´ ì£¼ê°„ ìŠ¤ì¼€ì¤„ ë°ì´í„° í™•ì¸ (í•´ë‹¹ ì›”)
      const monthSchedulesQuery = query(
        collection(db, 'weeklySchedules'),
        where('month', '==', selectedMonth)
      );
      const monthSchedulesSnapshot = await getDocs(monthSchedulesQuery);
      console.log('PayrollCalculation - í•´ë‹¹ ì›”ì˜ ëª¨ë“  ì£¼ê°„ ìŠ¤ì¼€ì¤„:', monthSchedulesSnapshot.docs.length, 'ê±´');
      
      if (monthSchedulesSnapshot.docs.length > 0) {
        console.log('PayrollCalculation - í•´ë‹¹ ì›”ì˜ ì£¼ê°„ ìŠ¤ì¼€ì¤„ ë°ì´í„°:', monthSchedulesSnapshot.docs.map(doc => ({
          id: doc.id,
          branchId: doc.data().branchId,
          month: doc.data().month,
          employeeId: doc.data().employeeId
        })));
      }
      
      // ì „ì²´ ì£¼ê°„ ìŠ¤ì¼€ì¤„ ë°ì´í„° í™•ì¸ (ëª¨ë“  ë°ì´í„°)
      const allSchedulesQuery2 = query(collection(db, 'weeklySchedules'));
      const allSchedulesSnapshot2 = await getDocs(allSchedulesQuery2);
      console.log('PayrollCalculation - ì „ì²´ ì£¼ê°„ ìŠ¤ì¼€ì¤„ ë°ì´í„°:', allSchedulesSnapshot2.docs.length, 'ê±´');
      
      if (allSchedulesSnapshot2.docs.length > 0) {
        console.log('PayrollCalculation - ì „ì²´ ì£¼ê°„ ìŠ¤ì¼€ì¤„ ë°ì´í„° (ì²˜ìŒ 5ê°œ):', allSchedulesSnapshot2.docs.slice(0, 5).map(doc => ({
          id: doc.id,
          branchId: doc.data().branchId,
          month: doc.data().month,
          employeeId: doc.data().employeeId
        })));
      }
      
      const schedulesData = schedulesSnapshot.docs.map(doc => {
        const data = doc.data();
        return {
          id: doc.id,
          employeeId: data.employeeId,
          branchId: data.branchId,
          branchName: data.branchName,
          month: data.month,
          date: data.date,
          actualWorkHours: data.actualWorkHours || 0,
          breakTime: data.breakTime || 0,
          weekStart: data.weekStart ? data.weekStart.toDate() : new Date(),
          weekEnd: data.weekEnd ? data.weekEnd.toDate() : new Date(),
          schedules: []
        };
      }) as WeeklySchedule[];
      
      console.log('PayrollCalculation - ì£¼ê°„ ìŠ¤ì¼€ì¤„ ë°ì´í„°:', schedulesData);
      setWeeklySchedules(schedulesData);
    } catch (error) {
      console.error('ì£¼ê°„ ìŠ¤ì¼€ì¤„ ë¡œë“œ ì‹¤íŒ¨:', error);
    } finally {
      setLoading(false);
    }
  }, [selectedMonth, selectedBranchId, selectedEmployeeId]);

  // ğŸ”¥ ê°œì„ ëœ ê¸‰ì—¬ ê³„ì‚° (PayrollCalculator í´ë˜ìŠ¤ ì‚¬ìš©)
  const calculatePayroll = useCallback(async () => {
    console.log('ğŸ”¥ calculatePayroll ì‹œì‘:', {
      employeesLength: employees.length,
      selectedEmployeeId: selectedEmployeeId,
      weeklySchedulesLength: weeklySchedules.length
    });
    
    if (!employees.length || !selectedEmployeeId) {
      console.log('ğŸ”¥ calculatePayroll ì¡°ê±´ ë¯¸ì¶©ì¡±ìœ¼ë¡œ ì¢…ë£Œ');
      return;
    }
    
    // ğŸ”¥ ì§€ì  ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì§ì ‘ ë¡œë“œ
    let branchesData = branches;
    if (branchesData.length === 0) {
      console.log('ğŸ”¥ PayrollCalculation - ì§€ì  ë°ì´í„° ì—†ìŒ, ì§ì ‘ ë¡œë“œ ì‹œì‘');
      try {
        const branchesSnapshot = await getDocs(collection(db, 'branches'));
        branchesData = branchesSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        })) as Branch[];
        console.log('ğŸ”¥ PayrollCalculation - ì§ì ‘ ë¡œë“œëœ ì§€ì  ë°ì´í„°:', branchesData.length, 'ê°œ');
      } catch (error) {
        console.error('ì§€ì  ë°ì´í„° ì§ì ‘ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }
    
    if (!weeklySchedules.length) {
      setNoScheduleData(true);
      setPayrollCalculations([]);
      return;
    }
    
    setNoScheduleData(false);

    const calculations: PayrollCalculation[] = [];

    // ì„ íƒëœ ì§ì›ë§Œ ê³„ì‚°
    const employee = employees.find(emp => emp.id === selectedEmployeeId);
    if (!employee) {
      return;
    }
    
    
    console.log('PayrollCalculation - ì„ íƒëœ ì§ì› ì •ë³´:', {
      id: employee.id,
      name: employee.name,
      salaryType: employee.salaryType,
      hourlyWage: employee.hourlyWage,
      monthlySalary: employee.monthlySalary,
      employmentType: employee.employmentType
    });

    // í•´ë‹¹ ì§ì›ì˜ ì£¼ê°„ ìŠ¤ì¼€ì¤„ í•„í„°ë§
    const employeeSchedules = weeklySchedules.filter(schedule => 
      schedule.employeeId === employee.id
    );

    if (employeeSchedules.length === 0) return;

    // ğŸ”¥ PayrollCalculator í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•œ ê³„ì‚°
    try {
      // ë°ì´í„° ë³€í™˜
      const employeeData = {
        id: employee.id,
        name: employee.name,
        employmentType: employee.employmentType,
        salaryType: employee.salaryType,
        hourlyWage: employee.hourlyWage,
        monthlySalary: employee.monthlySalary,
        probationStartDate: employee.probationStartDate,
        probationEndDate: employee.probationEndDate,
        includesWeeklyHolidayInWage: employee.includesWeeklyHolidayInWage
      };

      const contractData = {
        employmentType: employee.employmentType,
        salaryType: employee.salaryType,
        salaryAmount: employee.hourlyWage || employee.monthlySalary || 0,
        hourlyWage: employee.hourlyWage,
        monthlySalary: employee.monthlySalary,
        weeklyWorkHours: employee.weeklyWorkHours || 40,
        includeHolidayAllowance: employee.includesWeeklyHolidayInWage
      };

      const scheduleData = employeeSchedules.map(schedule => ({
        date: schedule.date,
        actualWorkHours: schedule.actualWorkHours,
        branchId: schedule.branchId,
        branchName: schedule.branchName
      }));

      // PayrollCalculator ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ê³„ì‚°
      const calculator = new PayrollCalculator(employeeData, contractData, scheduleData);
      const result = calculator.calculate();

      // ê²°ê³¼ë¥¼ PayrollCalculation íƒ€ì…ìœ¼ë¡œ ë³€í™˜
      const calculation: PayrollCalculation = {
        employeeId: result.employeeId,
        employeeName: result.employeeName,
        employmentType: result.employmentType,
        salaryType: result.salaryType,
        hourlyWage: result.hourlyWage,
        monthlySalary: result.monthlySalary,
        totalWorkHours: result.totalWorkHours,
        totalBreakTime: result.totalBreakTime,
        actualWorkHours: result.actualWorkHours,
        grossPay: result.grossPay,
        deductions: result.deductions,
        netPay: result.netPay,
        branches: result.branches,
        probationHours: result.probationHours,
        regularHours: result.regularHours,
        probationPay: result.probationPay,
        regularPay: result.regularPay,
        weeklyHolidayPay: result.weeklyHolidayPay,
        weeklyHolidayHours: result.weeklyHolidayHours,
        includesWeeklyHolidayInWage: result.includesWeeklyHolidayInWage,
        weeklyHolidayDetails: result.weeklyHolidayDetails,
        unpaidLeaveDays: result.unpaidLeaveDays,
        unpaidLeaveDeduction: result.unpaidLeaveDeduction
      };

      calculations.push(calculation);
      
      console.log('ğŸ”¥ PayrollCalculator ê³„ì‚° ì™„ë£Œ:', calculation);

    } catch (error) {
      console.error('PayrollCalculator ê³„ì‚° ì‹¤íŒ¨:', error);
      alert('ê¸‰ì—¬ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      return;
    }

    // ğŸ”¥ PayrollCalculator í´ë˜ìŠ¤ê°€ ëª¨ë“  ê³„ì‚°ì„ ì²˜ë¦¬í–ˆìœ¼ë¯€ë¡œ ê²°ê³¼ë§Œ ì„¤ì •
    setPayrollCalculations(calculations);
    console.log('ğŸ”¥ calculatePayroll ì™„ë£Œ:', {
      calculationsLength: calculations.length,
      calculations: calculations
    });
  }, [selectedEmployeeId]); // eslint-disable-line react-hooks/exhaustive-deps

  // ë©”ëª¨ ë¡œë“œ (WorkTimeComparisonê³¼ ë™ì¼í•œ ë°©ì‹)
  const loadMemo = useCallback(async () => {
    if (!selectedMonth) return;
    
    try {
      const memosQuery = query(
        collection(db, 'employeeMemos'),
        where('month', '==', selectedMonth),
        where('employeeId', '==', selectedEmployeeId)
      );
      
      const memosSnapshot = await getDocs(memosQuery);
      if (!memosSnapshot.empty) {
        const memoData = memosSnapshot.docs[0].data();
        setMemo(memoData.memo || '');
      } else {
        setMemo('');
      }
    } catch (error) {
      console.error('ë©”ëª¨ ë¡œë“œ ì‹¤íŒ¨:', error);
      setMemo('');
    }
  }, [selectedMonth, selectedEmployeeId]);

  // ë©”ëª¨ ì €ì¥
  const saveMemo = useCallback(async () => {
    if (!selectedMonth || !selectedEmployeeId) return;
    
    try {
      // ê¸°ì¡´ ë©”ëª¨ê°€ ìˆëŠ”ì§€ í™•ì¸
      const existingMemoQuery = query(
        collection(db, 'employeeMemos'),
        where('month', '==', selectedMonth),
        where('employeeId', '==', selectedEmployeeId)
      );
      
      const existingMemoSnapshot = await getDocs(existingMemoQuery);
      
      if (!existingMemoSnapshot.empty) {
        // ê¸°ì¡´ ë©”ëª¨ ì—…ë°ì´íŠ¸
        const memoDoc = existingMemoSnapshot.docs[0];
        await updateDoc(doc(db, 'employeeMemos', memoDoc.id), {
          memo: memo,
          updatedAt: new Date()
        });
      } else {
        // ìƒˆ ë©”ëª¨ ìƒì„±
        await addDoc(collection(db, 'employeeMemos'), {
          month: selectedMonth,
          employeeId: selectedEmployeeId,
          memo: memo,
          createdAt: new Date(),
          updatedAt: new Date()
        });
      }
      
      alert('ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch (error) {
      console.error('ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨:', error);
      alert('ë©”ëª¨ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }, [selectedMonth, selectedEmployeeId, memo]);

  // ê¸‰ì—¬ í™•ì •
  const handleConfirmPayroll = useCallback(async () => {
    if (!selectedMonth || !selectedEmployeeId || payrollCalculations.length === 0) return;
    
    try {
      // ê¸‰ì—¬ í™•ì • ë°ì´í„° ìƒì„±
      const confirmedPayrollData = {
        month: selectedMonth,
        employeeId: selectedEmployeeId,
        employeeName: payrollCalculations[0].employeeName,
        calculations: payrollCalculations,
        confirmedAt: new Date(),
        confirmedBy: 'admin' // TODO: ì‹¤ì œ ì‚¬ìš©ì ì •ë³´ë¡œ ë³€ê²½
      };
      
      // Firestoreì— ì €ì¥
      await addDoc(collection(db, 'confirmedPayrolls'), confirmedPayrollData);
      
      alert('ê¸‰ì—¬ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
      
      // ë¶€ëª¨ ì»´í¬ë„ŒíŠ¸ì— ë³€ê²½ ì‚¬í•­ ì•Œë¦¼
      if (onPayrollStatusChange) {
        onPayrollStatusChange();
      }
    } catch (error) {
      console.error('ê¸‰ì—¬ í™•ì • ì‹¤íŒ¨:', error);
      alert('ê¸‰ì—¬ í™•ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }, [selectedMonth, selectedEmployeeId, payrollCalculations, onPayrollStatusChange]);

  // useEffect hooks
  useEffect(() => {
    if (selectedEmployeeId && employees.length > 0 && weeklySchedules.length > 0) {
      calculatePayroll();
    }
  }, [selectedEmployeeId, employees, weeklySchedules, calculatePayroll]);

  useEffect(() => {
    if (selectedEmployeeId) {
      loadMemo();
    }
  }, [selectedEmployeeId, loadMemo]);

  // ë Œë”ë§
  if (loading) {
    return (
      <div className="flex justify-center items-center h-64">
        <div className="text-lg">ë¡œë”© ì¤‘...</div>
      </div>
    );
  }

  if (!selectedEmployeeId) {
    return (
      <div className="text-center py-8">
        <p className="text-gray-500">ì§ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
      </div>
    );
  }

  if (noScheduleData) {
    return (
      <div className="text-center py-8">
        <p className="text-gray-500">í•´ë‹¹ ì›”ì˜ ìŠ¤ì¼€ì¤„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* ê¸‰ì—¬ ê³„ì‚° ê²°ê³¼ */}
      {payrollCalculations.map((calc, index) => (
        <div key={index} className="bg-white rounded-lg shadow p-6">
          <h3 className="text-lg font-semibold mb-4">{calc.employeeName} ê¸‰ì—¬ ê³„ì‚°</h3>
          
          {/* ê·¼ë¬´ì‹œê°„ ìš”ì•½ */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div className="bg-blue-50 p-4 rounded-lg">
              <h4 className="font-medium text-blue-800">ì´ ê·¼ë¬´ì‹œê°„</h4>
              <p className="text-2xl font-bold text-blue-900">{calc.totalWorkHours.toFixed(1)}ì‹œê°„</p>
            </div>
            <div className="bg-green-50 p-4 rounded-lg">
              <h4 className="font-medium text-green-800">ì‹¤ ê·¼ë¬´ì‹œê°„</h4>
              <p className="text-2xl font-bold text-green-900">{calc.actualWorkHours.toFixed(1)}ì‹œê°„</p>
            </div>
            <div className="bg-purple-50 p-4 rounded-lg">
              <h4 className="font-medium text-purple-800">ì‹¤ìˆ˜ë ¹ì•¡</h4>
              <p className="text-2xl font-bold text-purple-900">{calc.netPay.toLocaleString()}ì›</p>
            </div>
          </div>
          
          {/* ê¸‰ì—¬ ìƒì„¸ */}
          <div className="overflow-x-auto mb-4">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ê¸°ë³¸ê¸‰</th>
                  {calc.salaryType === 'ì‹œê¸‰' && (
                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ì£¼íœ´ìˆ˜ë‹¹</th>
                  )}
                  <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                    {calc.employmentType === 'ê·¼ë¡œì†Œë“' ? '4ëŒ€ë³´í—˜' : 'ì‚¬ì—…ì†Œë“ê³µì œ'}
                  </th>
                  <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ì´ ê³µì œì•¡</th>
                  <th className="px-4 py-2 text-sm font-bold text-blue-700 bg-blue-50">ì‹¤ìˆ˜ë ¹ì•¡</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                <tr>
                  <td className="px-4 py-2 text-sm text-gray-900">
                    {calc.salaryType === 'ì‹œê¸‰' 
                      ? (calc.grossPay - (calc.weeklyHolidayPay || 0)).toLocaleString() + 'ì›'
                      : calc.grossPay.toLocaleString() + 'ì›'
                    }
                  </td>
                  {calc.salaryType === 'ì‹œê¸‰' && (
                    <td className="px-4 py-2 text-sm text-gray-900">
                      {calc.weeklyHolidayPay ? calc.weeklyHolidayPay.toLocaleString() + 'ì›' : '-'}
                    </td>
                  )}
                  <td className="px-4 py-2 text-sm text-gray-900">
                    {calc.employmentType === 'ê·¼ë¡œì†Œë“' && calc.deductions.insuranceDetails ? (
                      <div className="text-xs">
                        <div>êµ­ë¯¼ì—°ê¸ˆ: {calc.deductions.insuranceDetails.nationalPension.toLocaleString()}ì›</div>
                        <div>ê±´ê°•ë³´í—˜: {calc.deductions.insuranceDetails.healthInsurance.toLocaleString()}ì›</div>
                        <div>ì¥ê¸°ìš”ì–‘: {calc.deductions.insuranceDetails.longTermCare.toLocaleString()}ì›</div>
                        <div>ê³ ìš©ë³´í—˜: {calc.deductions.insuranceDetails.employmentInsurance.toLocaleString()}ì›</div>
                        <div className="font-medium pt-1 border-t">
                          í•©ê³„: {calc.deductions.insurance.toLocaleString()}ì›
                        </div>
                      </div>
                    ) : calc.employmentType === 'ê·¼ë¡œì†Œë“' ? (
                      calc.deductions.insurance > 0 ? calc.deductions.insurance.toLocaleString() + 'ì›' : '-'
                    ) : (
                      calc.deductions.tax > 0 ? calc.deductions.tax.toLocaleString() + 'ì›' : '-'
                    )}
                  </td>
                  <td className="px-4 py-2 text-sm text-red-600">{calc.deductions.total.toLocaleString()}ì›</td>
                  <td className="px-4 py-2 text-sm font-bold text-blue-700 bg-blue-50">{calc.netPay.toLocaleString()}ì›</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          {/* ê¸‰ì—¬ í™•ì • ë²„íŠ¼ */}
          <div className="flex justify-end space-x-4">
            <button
              onClick={handleConfirmPayroll}
              className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium"
            >
              ê¸‰ì—¬ í™•ì •
            </button>
          </div>
        </div>
      ))}
    </div>
  );
};

export default PayrollCalculation;
          
          const actualWorkHours = schedule.actualWorkHours || 0;
          
          // ìˆ˜ìŠµê¸°ê°„ ì—¬ë¶€ íŒë‹¨
          let isInProbation = false;
          if (probationStart && probationEnd && scheduleDate) {
            // ë‚ ì§œë§Œ ë¹„êµ (ì‹œê°„ ì œê±°)
            const scheduleDateOnly = new Date(scheduleDate.toISOString().split('T')[0]);
            const probationStartOnly = new Date(probationStart.toISOString().split('T')[0]);
            const probationEndOnly = new Date(probationEnd.toISOString().split('T')[0]);
            
            isInProbation = scheduleDateOnly >= probationStartOnly && scheduleDateOnly <= probationEndOnly;
            
            console.log(`ğŸ”¥ ìŠ¤ì¼€ì¤„ [${index}] ìˆ˜ìŠµê¸°ê°„ íŒë‹¨:`, {
              date: schedule.date,
              scheduleDateOnly: scheduleDateOnly.toISOString().split('T')[0],
              probationStartOnly: probationStartOnly.toISOString().split('T')[0],
              probationEndOnly: probationEndOnly.toISOString().split('T')[0],
              isInProbation: isInProbation,
              actualWorkHours: actualWorkHours
            });
          }
          
          if (isInProbation) {
            probationHours += actualWorkHours;
            console.log(`  âœ… ìˆ˜ìŠµê¸°ê°„ ì‹œê°„ ì¶”ê°€: +${actualWorkHours}ì‹œê°„ (ëˆ„ì : ${probationHours}ì‹œê°„)`);
          } else {
            regularHours += actualWorkHours;
            console.log(`  âœ… ì •ê·œ ì‹œê°„ ì¶”ê°€: +${actualWorkHours}ì‹œê°„ (ëˆ„ì : ${regularHours}ì‹œê°„)`);
          }
        });
        
        console.log(`ğŸ”¥ğŸ”¥ğŸ”¥ ${employee.name} ìˆ˜ìŠµê¸°ê°„ ê³„ì‚° ì™„ë£Œ:`, {
          probationHours: probationHours,
          regularHours: regularHours,
          totalHours: probationHours + regularHours
        });
      }
      
      console.log('PayrollCalculation - ìˆ˜ìŠµê¸°ê°„ë³„ ê·¼ë¬´ì‹œê°„ ê³„ì‚°:', {
        probationStart: probationStart,
        probationEnd: probationEnd,
        probationHours: probationHours,
        regularHours: regularHours,
        totalHours: probationHours + regularHours
      });
      
      console.log('PayrollCalculation - ìˆ˜ìŠµê¸°ê°„ë³„ ê·¼ë¬´ì‹œê°„ ê³„ì‚°:', {
        probationStart: probationStart,
        probationEnd: probationEnd,
        probationHours: probationHours,
        regularHours: regularHours,
        totalHours: probationHours + regularHours
      });
      
      console.log('PayrollCalculation - ìˆ˜ìŠµê¸°ê°„ë³„ ê·¼ë¬´ì‹œê°„:', {
        employeeName: employee.name,
        probationHours: probationHours,
        regularHours: regularHours,
        totalHours: probationHours + regularHours,
        probationStartDate: probationStartDate,
        probationEndDate: probationEndDate,
        schedulesCount: employeeSchedules.length,
        scheduleDates: employeeSchedules.map(s => s.weekStart)
      });
      
      // ê¸‰ì—¬ = a Ã— ì‹œê¸‰ Ã— 0.9 + b Ã— ì‹œê¸‰
      const probationPay = Math.round(probationHours * employee.hourlyWage * 0.9);
      const regularPay = Math.round(regularHours * employee.hourlyWage);
      const basePay = probationPay + regularPay;
      
      // ì£¼íœ´ìˆ˜ë‹¹ ê³„ì‚° (ê·¼ë¡œì†Œë“, ì‚¬ì—…ì†Œë“, ì™¸êµ­ì¸ & ì‹œê¸‰ & ì£¼íœ´ìˆ˜ë‹¹ ë¯¸í¬í•¨)
      
      const shouldCalculateWeeklyHoliday = 
        (employee.employmentType === 'ê·¼ë¡œì†Œë“' || employee.employmentType === 'ì‚¬ì—…ì†Œë“' || employee.employmentType === 'ì™¸êµ­ì¸') &&
        !employee.includesWeeklyHolidayInWage;
      
      console.log('ğŸ”¥ ì£¼íœ´ìˆ˜ë‹¹ ê³„ì‚° ì¡°ê±´:', {
        employeeName: employee.name,
        employmentType: employee.employmentType,
        includesWeeklyHolidayInWage: employee.includesWeeklyHolidayInWage,
        shouldCalculateWeeklyHoliday: shouldCalculateWeeklyHoliday,
        employeeSchedulesLength: employeeSchedules.length
      });
      
      if (shouldCalculateWeeklyHoliday) {
        // ì£¼ë³„ë¡œ ì£¼íœ´ìˆ˜ë‹¹ ê³„ì‚° (employeeSchedulesë¥¼ ì£¼ë³„ë¡œ ê·¸ë£¹í•‘)
        // ğŸ”¥ schedule.dateë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•´ë‹¹ ì£¼ì˜ ì›”ìš”ì¼ì„ ê³„ì‚°
        const weeklyScheduleGroups = employeeSchedules.reduce((groups, schedule) => {
          // schedule.dateë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì£¼ ì‹œì‘ì¼(ì›”ìš”ì¼) ê³„ì‚°
          const scheduleDate = schedule.date ? new Date(schedule.date) : schedule.weekStart;
          const dayOfWeek = scheduleDate.getDay(); // 0=ì¼, 1=ì›”, ..., 6=í† 
          const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // ì›”ìš”ì¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
          
          const monday = new Date(scheduleDate);
          monday.setDate(monday.getDate() - daysFromMonday);
          const weekKey = monday.toISOString().split('T')[0]; // ì£¼ ì‹œì‘ì¼(ì›”ìš”ì¼)ì„ í‚¤ë¡œ ì‚¬ìš©
          
          if (!groups[weekKey]) {
            groups[weekKey] = [];
          }
          groups[weekKey].push(schedule);
          return groups;
        }, {} as Record<string, typeof employeeSchedules>);
        
        // ê° ì£¼ë³„ë¡œ ì£¼íœ´ìˆ˜ë‹¹ ê³„ì‚°
        console.log('ğŸ”¥ ì£¼íœ´ìˆ˜ë‹¹ ê³„ì‚° ì‹œì‘ - ì£¼ë³„ ê·¸ë£¹:', Object.keys(weeklyScheduleGroups));
        
        Object.entries(weeklyScheduleGroups).forEach(([weekKey, weekSchedules]) => {
          const weekStartDate = new Date(weekKey);
          const weekEndDate = new Date(weekStartDate);
          weekEndDate.setDate(weekEndDate.getDate() + 6); // ì£¼ ì‹œì‘ì¼ + 6ì¼ = ì¼ìš”ì¼
          
          // ğŸ”¥ ì™„ì „í•œ ì£¼ì¸ì§€ í™•ì¸ (ì¼ìš”ì¼ë¡œ ëë‚˜ëŠ”ì§€)
          const isCompleteWeek = weekEndDate.getDay() === 0; // 0 = ì¼ìš”ì¼
          
          // ğŸ”¥ í•´ë‹¹ ì›” ë‚´ì— ì†í•˜ëŠ”ì§€ í™•ì¸
          const monthDate = typeof selectedMonth === 'string' ? new Date(selectedMonth) : selectedMonth;
          const monthEnd = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);
          
          // ğŸ”¥ ì£¼ ë(ì¼ìš”ì¼)ì´ ì´ë²ˆ ë‹¬ì— ì†í•˜ì§€ ì•Šìœ¼ë©´ ë‹¤ìŒ ë‹¬ì— ì§€ê¸‰
          const weekEndsInCurrentMonth = weekEndDate <= monthEnd;
          
          console.log(`ğŸ”¥ ì£¼ì°¨ ${weekKey} ì²´í¬:`, {
            weekStartDate: weekStartDate.toLocaleDateString(),
            weekEndDate: weekEndDate.toLocaleDateString(),
            weekEndDay: weekEndDate.getDay(),
            isCompleteWeek: isCompleteWeek,
            weekEndsInCurrentMonth: weekEndsInCurrentMonth,
            monthEnd: monthEnd.toLocaleDateString()
          });
          
          // ğŸ”¥ ì™„ì „í•œ ì£¼ì´ê³ , ì¼ìš”ì¼ì´ ì´ë²ˆ ë‹¬ì— ì†í•  ë•Œë§Œ ì£¼íœ´ìˆ˜ë‹¹ ì§€ê¸‰
          if (!isCompleteWeek || !weekEndsInCurrentMonth) {
            console.log(`ğŸ”¥ ì£¼ì°¨ ${weekKey} ì£¼íœ´ìˆ˜ë‹¹ ì œì™¸ (ë¶ˆì™„ì „í•œ ì£¼ ë˜ëŠ” ë‹¤ìŒ ë‹¬)`);
            weeklyHolidayDetails.push({
              weekStart: weekStartDate.toLocaleDateString('ko-KR'),
              weekEnd: weekEndDate.toLocaleDateString('ko-KR'),
              hours: 0,
              pay: 0,
              eligible: false,
              reason: !isCompleteWeek ? 'ë¶ˆì™„ì „í•œ ì£¼ (ì¼ìš”ì¼ë¡œ ëë‚˜ì§€ ì•ŠìŒ)' : 'ë‹¤ìŒ ë‹¬ë¡œ ì´ì›”'
            });
            return; // ì´ ì£¼ëŠ” ì£¼íœ´ìˆ˜ë‹¹ ê³„ì‚°í•˜ì§€ ì•ŠìŒ
          }
          
          console.log(`ğŸ”¥ ì£¼ì°¨ ${weekKey} ì£¼íœ´ìˆ˜ë‹¹ ê³„ì‚° ì§„í–‰`);
          
          const weeklyWorkdays = employee.weeklyWorkdays || 5; // ê¸°ë³¸ ì£¼ 5ì¼
          const weeklyActualHours = weekSchedules.reduce((sum, s) => sum + s.actualWorkHours, 0);
          
          // ğŸ”¥ ì†Œì •ê·¼ë¡œì¼ ëª¨ë‘ ì´í–‰ ì—¬ë¶€ í™•ì¸ - ì‹¤ì œ ìŠ¤ì¼€ì¤„ì´ ìˆëŠ” ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ íŒë‹¨
          // weekSchedulesì— ìŠ¤ì¼€ì¤„ì´ ìˆë‹¤ëŠ” ê²ƒì€ ê·¸ ë‚  ê·¼ë¬´í–ˆë‹¤ëŠ” ì˜ë¯¸
          const actualWorkdays = weekSchedules.length;
          const workedAllScheduledDays = actualWorkdays > 0; // ìŠ¤ì¼€ì¤„ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì¶œê·¼ìœ¼ë¡œ ì¸ì •
          
          // ì²« ì£¼ íŒë‹¨ (í•´ë‹¹ ì›”ì˜ ì²« ì£¼ì¸ì§€)
          const isFirstWeek = weekStartDate.getDate() <= 7;
          
          console.log(`ğŸ”¥ ì£¼ì°¨ ${weekKey} ì£¼íœ´ìˆ˜ë‹¹ ê³„ì‚° ì…ë ¥:`, {
            hourlyWage: employee.hourlyWage,
            weeklyContractHours: weeklyActualHours,
            weeklyWorkdays: weeklyWorkdays,
            workedAllScheduledDays: workedAllScheduledDays,
            schedulesCount: weekSchedules.length,
            isFirstWeek: isFirstWeek
          });
          
          const weeklyHolidayResult = calcWeeklyHolidayPay({
            hourlyWage: employee.hourlyWage || 0,
            weeklyContractHours: weeklyActualHours, // ì‹¤ì œ ê·¼ë¬´ì‹œê°„ ê¸°ì¤€
            weeklyWorkdays: weeklyWorkdays,
            workedAllScheduledDays: workedAllScheduledDays,
            isFirstWeek: isFirstWeek,
            carryoverHoursPrevWeek: 0, // ì „ë‹¬ ì£¼ í•©ì‚°ì€ ì¶”í›„ êµ¬í˜„
            requirePrevWeekAttendance: false
          });
          
          console.log(`ğŸ”¥ ì£¼ì°¨ ${weekKey} ì£¼íœ´ìˆ˜ë‹¹ ê³„ì‚° ê²°ê³¼:`, weeklyHolidayResult);
          
          if (weeklyHolidayResult.eligible) {
            // ğŸ”¥ ìˆ˜ìŠµê¸°ê°„ ì¤‘ì¸ ì£¼ì¸ì§€ í™•ì¸
            const probationStart = probationStartDate && typeof probationStartDate === 'object' && 'toDate' in probationStartDate 
              ? probationStartDate.toDate() 
              : probationStartDate as Date | undefined;
            const probationEnd = probationEndDate && typeof probationEndDate === 'object' && 'toDate' in probationEndDate 
              ? probationEndDate.toDate() 
              : probationEndDate as Date | undefined;
            
            // ì£¼ì˜ ì¼ìš”ì¼ì´ ìˆ˜ìŠµê¸°ê°„ì— ì†í•˜ëŠ”ì§€ í™•ì¸
            const isWeekInProbation = probationStart && probationEnd && 
              weekEndDate >= probationStart && weekEndDate <= probationEnd;
            
            // ğŸ”¥ ìˆ˜ìŠµê¸°ê°„ì´ë©´ ì£¼íœ´ìˆ˜ë‹¹ë„ 90% ì§€ê¸‰
            const adjustedPay = isWeekInProbation 
              ? Math.round(weeklyHolidayResult.pay * 0.9)
              : weeklyHolidayResult.pay;
            
            weeklyHolidayDetails.push({
              weekStart: weekStartDate.toLocaleDateString('ko-KR'),
              weekEnd: weekEndDate.toLocaleDateString('ko-KR'),
              hours: weeklyHolidayResult.hours,
              pay: adjustedPay,
              eligible: true,
              reason: isWeekInProbation ? 'ì§€ê¸‰ (ìˆ˜ìŠµê¸°ê°„ 90%)' : 'ì§€ê¸‰'
            });
            
            weeklyHolidayPay += adjustedPay;
            weeklyHolidayHours += weeklyHolidayResult.hours;
          } else {
            weeklyHolidayDetails.push({
              weekStart: weekStartDate.toLocaleDateString('ko-KR'),
              weekEnd: weekEndDate.toLocaleDateString('ko-KR'),
              hours: 0,
              pay: 0,
              eligible: false,
              reason: 'ì£¼ 15ì‹œê°„ ë¯¸ë§Œ ë˜ëŠ” ì¶œê·¼ ë¯¸ì¶©ì¡±'
            });
          }
        });
      }
      
      grossPay = basePay + weeklyHolidayPay;
      
      console.log('PayrollCalculation - ìˆ˜ìŠµê¸°ê°„ë³„ ê¸‰ì—¬ ê³„ì‚°:', {
        probationPay: probationPay,
        regularPay: regularPay,
        basePay: basePay,
        weeklyHolidayPay: weeklyHolidayPay,
        weeklyHolidayHours: weeklyHolidayHours,
        totalPay: grossPay
      });
      
    } else if ((employee.salaryType === 'ì›”ê¸‰' || employee.salaryType === 'monthly') && employee.monthlySalary) {
      // ì›”ê¸‰ì¸ ê²½ìš° ê³„ì‚°
      console.log('PayrollCalculation - ì›”ê¸‰ ê³„ì‚° ì‹œì‘:', {
        employeeName: employee.name,
        monthlySalary: employee.monthlySalary,
        probationStartDate: probationStartDate,
        probationEndDate: probationEndDate
      });
      
      // Timestamp ê°ì²´ë¥¼ Date ê°ì²´ë¡œ ë³€í™˜
      const probationStart = probationStartDate && typeof probationStartDate === 'object' && 'toDate' in probationStartDate 
        ? probationStartDate.toDate() 
        : probationStartDate as Date | undefined;
      const probationEnd = probationEndDate && typeof probationEndDate === 'object' && 'toDate' in probationEndDate 
        ? probationEndDate.toDate() 
        : probationEndDate as Date | undefined;
      
      // í˜„ì¬ ì›”ì´ ìˆ˜ìŠµê¸°ê°„ì— í•´ë‹¹í•˜ëŠ”ì§€ í™•ì¸
      let isMonthInProbation = false;
      if (probationStart && probationEnd && selectedMonth) {
        const monthDate = new Date(selectedMonth);
        const monthStart = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
        const monthEnd = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);
        
        // ì›”ì˜ ì‹œì‘ì¼ ë˜ëŠ” ì¢…ë£Œì¼ì´ ìˆ˜ìŠµê¸°ê°„ì— í¬í•¨ë˜ë©´ ìˆ˜ìŠµê¸°ê°„ìœ¼ë¡œ íŒë‹¨
        isMonthInProbation = (monthStart >= probationStart && monthStart <= probationEnd) ||
                             (monthEnd >= probationStart && monthEnd <= probationEnd) ||
                             (monthStart <= probationStart && monthEnd >= probationEnd);
        
        console.log('PayrollCalculation - ì›”ê¸‰ ìˆ˜ìŠµê¸°ê°„ íŒë‹¨:', {
          selectedMonth: selectedMonth,
          monthStart: monthStart.toISOString().split('T')[0],
          monthEnd: monthEnd.toISOString().split('T')[0],
          probationStart: probationStart.toISOString().split('T')[0],
          probationEnd: probationEnd.toISOString().split('T')[0],
          isMonthInProbation: isMonthInProbation
        });
        
      }
      
      // ê¸°ë³¸ ì›”ê¸‰ ê³„ì‚°
      let baseSalary = employee.monthlySalary;
      
      if (isMonthInProbation) {
        // ìˆ˜ìŠµê¸°ê°„ ì¤‘ì—ëŠ” ì›”ê¸‰ì˜ 90% ì ìš©
        baseSalary = Math.round(employee.monthlySalary * 0.9);
        console.log('PayrollCalculation - ìˆ˜ìŠµê¸°ê°„ ì›”ê¸‰ ì ìš©:', employee.monthlySalary, 'ì› Ã— 0.9 =', baseSalary, 'ì›');
      } else {
        console.log('PayrollCalculation - ì •ê·œ ì›”ê¸‰ ì ìš©:', employee.monthlySalary, 'ì›');
      }
      
      // ë¬´ê¸‰íœ´ê°€ ì°¨ê° (ê·¼ë¡œì†Œë“ì+ì›”ê¸‰ì œë§Œ)
      
      if (employee.employmentType === 'ê·¼ë¡œì†Œë“') {
        // ë¬´ê¸‰íœ´ê°€ ì¼ìˆ˜ëŠ” ê¸‰ì—¬ë©”ëª¨ë‚˜ ë³„ë„ ì…ë ¥ì—ì„œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ (í˜„ì¬ëŠ” 0ìœ¼ë¡œ ì´ˆê¸°í™”)
        // TODO: ì‹¤ì œ ë¬´ê¸‰íœ´ê°€ ì¼ìˆ˜ ì…ë ¥ UI ì¶”ê°€ í•„ìš”
        unpaidLeaveDays = 0; // ì„ì‹œë¡œ 0ìœ¼ë¡œ ì„¤ì •
        
        if (unpaidLeaveDays > 0) {
          // ì¼í•  ê³„ì‚° (ì›” ê¸°ì¤€ì¼ìˆ˜ë¥¼ 30ì¼ë¡œ ê°€ì •)
          const dailyRate = baseSalary / 30;
          unpaidLeaveDeduction = Math.round(dailyRate * unpaidLeaveDays);
          grossPay = baseSalary - unpaidLeaveDeduction;
          
          console.log('PayrollCalculation - ë¬´ê¸‰íœ´ê°€ ì°¨ê°:', {
            baseSalary: baseSalary,
            unpaidLeaveDays: unpaidLeaveDays,
            dailyRate: dailyRate,
            unpaidLeaveDeduction: unpaidLeaveDeduction,
            finalGrossPay: grossPay
          });
        } else {
          grossPay = baseSalary;
        }
      } else {
        grossPay = baseSalary;
      }
    }

    // ê³µì œ ê³„ì‚°
    let insurance = 0;
    let tax = 0;
    let netPay = 0;
    
    // 4ëŒ€ë³´í—˜ ë° ì†Œë“ì„¸ ìƒì„¸ ì •ë³´ (ì „ì—­ ìŠ¤ì½”í”„)
    let insuranceDetails: {nationalPension: number, healthInsurance: number, longTermCare: number, employmentInsurance: number} | undefined;
    let taxDetails: {incomeTax: number, localIncomeTax: number} | undefined;

    if (employee.employmentType === 'ê·¼ë¡œì†Œë“') {
      // 4ëŒ€ë³´í—˜ ê³„ì‚° (2025ë…„ ê¸°ì¤€)
      const nationalPension = Math.round(grossPay * 0.045);      // êµ­ë¯¼ì—°ê¸ˆ 4.5%
      const healthInsurance = Math.round(grossPay * 0.03545);    // ê±´ê°•ë³´í—˜ 3.545%
      const longTermCare = Math.round(healthInsurance * 0.1295); // ì¥ê¸°ìš”ì–‘ë³´í—˜ (ê±´ê°•ë³´í—˜ì˜ 12.95%)
      const employmentInsurance = Math.round(grossPay * 0.009);  // ê³ ìš©ë³´í—˜ 0.9%
      
      // 4ëŒ€ë³´í—˜ ìƒì„¸ ì •ë³´ ì €ì¥
      insuranceDetails = {
        nationalPension,
        healthInsurance,
        longTermCare,
        employmentInsurance
      };
      
      insurance = nationalPension + healthInsurance + longTermCare + employmentInsurance;
      
      // ì†Œë“ì„¸ ê°„ì´ì„¸ì•¡í‘œ ì ìš© (ë¶€ì–‘ê°€ì¡± 1ëª… ê¸°ì¤€, ê°„ë‹¨í•œ êµ¬ê°„ë³„ ê³„ì‚°)
      let incomeTax = 0;
      if (grossPay <= 1060000) {
        incomeTax = 0;
      } else if (grossPay <= 2100000) {
        incomeTax = Math.round((grossPay - 1060000) * 0.02);
      } else if (grossPay <= 3160000) {
        incomeTax = Math.round(20800 + (grossPay - 2100000) * 0.04);
      } else if (grossPay <= 5000000) {
        incomeTax = Math.round(63200 + (grossPay - 3160000) * 0.06);
      } else {
        incomeTax = Math.round(173600 + (grossPay - 5000000) * 0.08);
      }
      
      const localIncomeTax = Math.round(incomeTax * 0.1); // ì§€ë°©ì†Œë“ì„¸ (ì†Œë“ì„¸ì˜ 10%)
      
      // ì†Œë“ì„¸ ìƒì„¸ ì •ë³´ ì €ì¥
      taxDetails = {
        incomeTax,
        localIncomeTax
      };
      
      tax = incomeTax + localIncomeTax;
      
      netPay = grossPay - (insurance + tax);
      
      console.log('PayrollCalculation - ê·¼ë¡œì†Œë“ ê³µì œ ìƒì„¸:', {
        grossPay: grossPay,
        nationalPension: nationalPension,
        healthInsurance: healthInsurance,
        longTermCare: longTermCare,
        employmentInsurance: employmentInsurance,
        totalInsurance: insurance,
        incomeTax: incomeTax,
        localIncomeTax: localIncomeTax,
        totalTax: tax,
        netPay: netPay
      });
    } else if (employee.employmentType === 'ì‚¬ì—…ì†Œë“') {
      tax = Math.round(grossPay * 0.033); // 3.3% (ì†Œë“ì„¸ë§Œ)
      netPay = grossPay - tax; // ì„¸ê¸ˆ ì°¨ê°
      console.log('PayrollCalculation - ì‚¬ì—…ì†Œë“ ê³µì œ:', {
        grossPay: grossPay,
        tax: tax,
        netPay: netPay,
        rate: '96.7%'
      });
    } else if (employee.employmentType === 'ì¼ìš©ì§') {
      // ì¼ìš©ì§ì€ ê³µì œ ì—†ìŒ
      netPay = grossPay;
      console.log('PayrollCalculation - ì¼ìš©ì§ (ê³µì œì—†ìŒ):', {
        grossPay: grossPay,
        netPay: netPay
      });
    } else if (employee.employmentType === 'ì™¸êµ­ì¸') {
      tax = Math.round(grossPay * 0.033); // 3.3% (ì†Œë“ì„¸ë§Œ)
      netPay = grossPay - tax; // ì„¸ê¸ˆ ì°¨ê°
      console.log('PayrollCalculation - ì™¸êµ­ì¸ ê³µì œ:', {
        grossPay: grossPay,
        tax: tax,
        netPay: netPay,
        rate: '96.7%'
      });
    }

    const totalDeductions = insurance + tax;

    calculations.push({
      employeeId: employee.id,
      employeeName: employee.name,
      employmentType: employee.employmentType,
      salaryType: employee.salaryType,
      hourlyWage: employee.hourlyWage,
      monthlySalary: employee.monthlySalary,
      totalWorkHours,
      totalBreakTime,
      actualWorkHours,
      grossPay,
      deductions: {
        insurance,
        tax,
        total: totalDeductions,
        insuranceDetails,
        taxDetails
      },
      netPay,
      branches: Object.values(branchWorkHours),
      // ìˆ˜ìŠµê¸°ê°„ ê´€ë ¨ ê°’ë“¤ ì¶”ê°€
      probationHours: probationHours || 0,
      regularHours: regularHours || 0,
      probationPay: probationHours ? probationHours * (employee.hourlyWage || 0) * 0.9 : 0,
      regularPay: regularHours ? regularHours * (employee.hourlyWage || 0) : 0,
      // ì£¼íœ´ìˆ˜ë‹¹ ì¶”ê°€
      weeklyHolidayPay: weeklyHolidayPay || 0,
      weeklyHolidayHours: weeklyHolidayHours || 0,
      includesWeeklyHolidayInWage: employee.includesWeeklyHolidayInWage || false,
      weeklyHolidayDetails: weeklyHolidayDetails,
      // ë¬´ê¸‰íœ´ê°€ ê´€ë ¨ (ê·¼ë¡œì†Œë“ì+ì›”ê¸‰ì œ ì „ìš©)
      unpaidLeaveDays: unpaidLeaveDays || 0,
      unpaidLeaveDeduction: unpaidLeaveDeduction || 0
    });

    setPayrollCalculations(calculations);
    console.log('ğŸ”¥ calculatePayroll ì™„ë£Œ:', {
      calculationsLength: calculations.length,
      calculations: calculations
    });
  }, [selectedEmployeeId]); // eslint-disable-line react-hooks/exhaustive-deps

  // ë©”ëª¨ ë¡œë“œ (WorkTimeComparisonê³¼ ë™ì¼í•œ ë°©ì‹)
  const loadMemo = useCallback(async () => {
    if (!selectedMonth) return;
    
    try {
      const memosQuery = query(
        collection(db, 'employeeMemos'),
        where('month', '==', selectedMonth)
      );
      const memosSnapshot = await getDocs(memosQuery);
      
      const memosMap: {[employeeId: string]: string} = {};
      memosSnapshot.docs.forEach(doc => {
        const data = doc.data();
        memosMap[data.employeeId] = data.memo || '';
      });
      
      setEmployeeMemos(memosMap);
      
    } catch (error) {
      console.error('ë©”ëª¨ ë¡œë“œ ì‹¤íŒ¨:', error);
    }
  }, [selectedMonth]);

  // ë©”ëª¨ ì €ì¥ (WorkTimeComparisonê³¼ ë™ì¼í•œ ë°©ì‹)
  const saveMemo = async () => {
    if (!selectedMonth || !selectedEmployeeId) return;
    
    setSavingMemo(true);
    
    try {
      const memoRecord = {
        employeeId: selectedEmployeeId,
        month: selectedMonth,
        memo: memo
      };
      
      // ê¸°ì¡´ ë©”ëª¨ê°€ ìˆëŠ”ì§€ í™•ì¸
      const existingQuery = query(
        collection(db, 'employeeMemos'),
        where('employeeId', '==', selectedEmployeeId),
        where('month', '==', selectedMonth)
      );
      const existingDocs = await getDocs(existingQuery);
      
      if (existingDocs.empty) {
        // ìƒˆë¡œ ì¶”ê°€
        await addDoc(collection(db, 'employeeMemos'), memoRecord);
      } else {
        // ê¸°ì¡´ ë°ì´í„° ì—…ë°ì´íŠ¸
        const docId = existingDocs.docs[0].id;
        await updateDoc(doc(db, 'employeeMemos', docId), memoRecord);
      }
      
      // ë¡œì»¬ ìƒíƒœë„ ì—…ë°ì´íŠ¸
      setEmployeeMemos(prev => ({
        ...prev,
        [selectedEmployeeId]: memo
      }));
      
    } catch (error) {
      console.error('ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨:', error);
      alert('ë©”ëª¨ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setSavingMemo(false);
    }
  };

  // ê¸‰ì—¬í™•ì • í•¨ìˆ˜
  const confirmPayroll = async (calculation: PayrollCalculation) => {
    if (!selectedMonth || !selectedBranchId || !selectedEmployeeId) {
      alert('ì›”, ì§€ì , ì§ì›ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    setConfirming(true);
    try {
      // ê¸‰ì—¬í™•ì • ë°ì´í„° êµ¬ì¡°
      const confirmedPayrollData = {
        // ê¸°ë³¸ ì •ë³´
        employeeId: calculation.employeeId,
        employeeName: calculation.employeeName,
        branchId: selectedBranchId,
        branchName: branches.find(b => b.id === selectedBranchId)?.name || '',
        month: selectedMonth,
        confirmedAt: new Date(),
        
        // ê¸‰ì—¬ ì •ë³´ (í™•ì • ì‹œì ì˜ ë°ì´í„° ë³´ì¡´)
        employmentType: calculation.employmentType,
        salaryType: calculation.salaryType,
        hourlyWage: calculation.hourlyWage,
        monthlySalary: calculation.monthlySalary,
        
        // ê·¼ë¬´ì‹œê°„ ì •ë³´
        totalWorkHours: calculation.totalWorkHours,
        totalBreakTime: calculation.totalBreakTime,
        actualWorkHours: calculation.actualWorkHours,
        
        // ìˆ˜ìŠµê¸°ê°„ ì •ë³´
        probationHours: calculation.probationHours || 0,
        regularHours: calculation.regularHours || 0,
        probationPay: calculation.probationPay || 0,
        regularPay: calculation.regularPay || 0,
        
        // ê¸‰ì—¬ ê³„ì‚°
        grossPay: calculation.grossPay,
        deductions: calculation.deductions,
        netPay: calculation.netPay,
        
        // ì§€ì ë³„ ì •ë³´
        branches: calculation.branches,
        
        // ìƒíƒœ
        status: 'confirmed'
      };

      // Firestoreì— ì €ì¥
      await addDoc(collection(db, 'confirmedPayrolls'), confirmedPayrollData);
      
      // ê¸‰ì—¬ì²˜ë¦¬ìƒíƒœë¥¼ "ê¸‰ì—¬í™•ì •ì™„ë£Œ"ë¡œ ì—…ë°ì´íŠ¸
      const reviewStatusQuery = query(
        collection(db, 'employeeReviewStatus'),
        where('employeeId', '==', selectedEmployeeId),
        where('branchId', '==', selectedBranchId),
        where('month', '==', selectedMonth)
      );
      const reviewStatusSnapshot = await getDocs(reviewStatusQuery);
      
      if (!reviewStatusSnapshot.empty) {
        const docId = reviewStatusSnapshot.docs[0].id;
        await updateDoc(doc(db, 'employeeReviewStatus', docId), {
          status: 'ê¸‰ì—¬í™•ì •ì™„ë£Œ',
          updatedAt: new Date()
        });
      } else {
        // ìƒíƒœê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
        // ğŸ”¥ ìµœì í™”: ìì£¼ ì¡°íšŒí•˜ëŠ” ë°ì´í„°ë¥¼ ì—­ì •ê·œí™”í•˜ì—¬ í¬í•¨
        const selectedEmployee = employees.find(emp => emp.id === selectedEmployeeId);
        const selectedBranch = branches.find(br => br.id === selectedBranchId);
        
        await addDoc(collection(db, 'employeeReviewStatus'), {
          employeeId: selectedEmployeeId,
          employeeName: selectedEmployee?.name || 'ì•Œ ìˆ˜ ì—†ìŒ', // ğŸ”¥ ì—­ì •ê·œí™”
          branchId: selectedBranchId,
          branchName: selectedBranch?.name || 'ì•Œ ìˆ˜ ì—†ìŒ', // ğŸ”¥ ì—­ì •ê·œí™”
          month: selectedMonth,
          status: 'ê¸‰ì—¬í™•ì •ì™„ë£Œ',
          createdAt: new Date(),
          updatedAt: new Date()
        });
      }
      
      // ğŸ”¥ ìµœì í™”: ê¸‰ì—¬í™•ì • ì‹œ ì§‘ê³„ ë°ì´í„° ìºì‹±
      if (payrollCalculations.length > 0) {
        const calc = payrollCalculations[0]; // í˜„ì¬ ì„ íƒëœ ì§ì›ì˜ ê³„ì‚° ê²°ê³¼
        const selectedEmployee = employees.find(emp => emp.id === selectedEmployeeId);
        const selectedBranch = branches.find(br => br.id === selectedBranchId);
        
        if (selectedEmployee && selectedBranch) {
          await updateEmployeeMonthlyStats(
            selectedEmployeeId,
            selectedEmployee.name,
            selectedBranchId,
            selectedBranch.name,
            selectedMonth,
            {
              totalWorkHours: calc.totalWorkHours,
              totalBreakTime: calc.totalBreakTime,
              actualWorkHours: calc.actualWorkHours,
              overtimeHours: 0, // TODO: ê³„ì‚° ë¡œì§ ì¶”ê°€
              weeklyHolidayHours: calc.weeklyHolidayHours || 0,
              weeklyHolidayPay: calc.weeklyHolidayPay || 0,
              grossPay: calc.grossPay,
              netPay: calc.netPay,
              isConfirmed: true
            }
          );
        }
      }
      
      alert('ê¸‰ì—¬ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
      
      // ìƒíƒœ ì—…ë°ì´íŠ¸
      setIsPayrollConfirmed(true);
      
      // ë¶€ëª¨ ì»´í¬ë„ŒíŠ¸ì— ìƒíƒœ ë³€ê²½ ì•Œë¦¼
      if (onPayrollStatusChange) {
        onPayrollStatusChange();
      }
      
    } catch (error) {
      console.error('ê¸‰ì—¬í™•ì • ì‹¤íŒ¨:', error);
      alert('ê¸‰ì—¬í™•ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setConfirming(false);
    }
  };

  // ê¸‰ì—¬í™•ì • ìƒíƒœ í™•ì¸
  const checkPayrollConfirmed = useCallback(async () => {
    if (!selectedMonth || !selectedBranchId || !selectedEmployeeId) {
      setIsPayrollConfirmed(false);
      return;
    }

    try {
      const confirmedPayrollsQuery = query(
        collection(db, 'confirmedPayrolls'),
        where('employeeId', '==', selectedEmployeeId),
        where('branchId', '==', selectedBranchId),
        where('month', '==', selectedMonth)
      );
      const confirmedPayrollsSnapshot = await getDocs(confirmedPayrollsQuery);
      
      setIsPayrollConfirmed(!confirmedPayrollsSnapshot.empty);
    } catch (error) {
      console.error('ê¸‰ì—¬í™•ì • ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
      setIsPayrollConfirmed(false);
    }
  }, [selectedMonth, selectedBranchId, selectedEmployeeId]);

  // ê¸‰ì—¬í™•ì • ì·¨ì†Œ í•¨ìˆ˜
  const cancelConfirmPayroll = async () => {
    if (!selectedMonth || !selectedBranchId || !selectedEmployeeId) {
      alert('ì›”, ì§€ì , ì§ì›ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    if (!confirm('ê¸‰ì—¬í™•ì •ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      return;
    }

    setConfirming(true);
    
    try {
      // confirmedPayrollsì—ì„œ ì‚­ì œ
      const confirmedPayrollsQuery = query(
        collection(db, 'confirmedPayrolls'),
        where('employeeId', '==', selectedEmployeeId),
        where('branchId', '==', selectedBranchId),
        where('month', '==', selectedMonth)
      );
      const confirmedPayrollsSnapshot = await getDocs(confirmedPayrollsQuery);
      
      for (const docSnapshot of confirmedPayrollsSnapshot.docs) {
        await deleteDoc(doc(db, 'confirmedPayrolls', docSnapshot.id));
      }
      
      // ê¸‰ì—¬ì²˜ë¦¬ìƒíƒœë¥¼ "ê·¼ë¬´ì‹œê°„ê²€í† ì™„ë£Œ"ë¡œ ë˜ëŒë¦¼
      const reviewStatusQuery = query(
        collection(db, 'employeeReviewStatus'),
        where('employeeId', '==', selectedEmployeeId),
        where('branchId', '==', selectedBranchId),
        where('month', '==', selectedMonth)
      );
      const reviewStatusSnapshot = await getDocs(reviewStatusQuery);
      
      if (!reviewStatusSnapshot.empty) {
        const docId = reviewStatusSnapshot.docs[0].id;
        await updateDoc(doc(db, 'employeeReviewStatus', docId), {
          status: 'ê·¼ë¬´ì‹œê°„ê²€í† ì™„ë£Œ',
          updatedAt: new Date()
        });
      }
      
      alert('ê¸‰ì—¬í™•ì •ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      
      // ìƒíƒœ ì—…ë°ì´íŠ¸
      setIsPayrollConfirmed(false);
      
      // ë¶€ëª¨ ì»´í¬ë„ŒíŠ¸ì— ìƒíƒœ ë³€ê²½ ì•Œë¦¼
      if (onPayrollStatusChange) {
        onPayrollStatusChange();
      }
      
    } catch (error) {
      console.error('ê¸‰ì—¬í™•ì • ì·¨ì†Œ ì‹¤íŒ¨:', error);
      alert('ê¸‰ì—¬í™•ì • ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setConfirming(false);
    }
  };

  // ğŸ”¥ ìµœì í™”: ì´ˆê¸° ë¡œë“œ (í•œ ë²ˆë§Œ ì‹¤í–‰)
  useEffect(() => {
    loadBranches();
    loadEmployees();
  }, []); // eslint-disable-line react-hooks/exhaustive-deps

  // ë©”ëª¨ ë¡œë“œ
  useEffect(() => {
    loadMemo();
  }, [selectedMonth]); // loadMemo ëŒ€ì‹  selectedMonth ì‚¬ìš©
  
  // selectedEmployeeIdê°€ ë³€ê²½ë  ë•Œ ë©”ëª¨ ì—…ë°ì´íŠ¸
  useEffect(() => {
    if (selectedEmployeeId && employeeMemos[selectedEmployeeId] !== undefined) {
      setMemo(employeeMemos[selectedEmployeeId]);
    } else {
      setMemo('');
    }
  }, [selectedEmployeeId, employeeMemos]);

  // ğŸ”¥ ìµœì í™”: selectedEmployeeId ë³€ê²½ ì‹œë§Œ ê¸‰ì—¬ê³„ì‚°
  useEffect(() => {
    if (selectedEmployeeId && employees.length > 0 && weeklySchedules.length > 0) {
      calculatePayroll();
    }
  }, [selectedEmployeeId, employees, weeklySchedules, calculatePayroll]);

  // ğŸ”¥ ìµœì í™”: ê¸‰ì—¬í™•ì • ìƒíƒœëŠ” í•„ìš”í•œ ê°’ì´ ë³€ê²½ë  ë•Œë§Œ í™•ì¸
  useEffect(() => {
    if (selectedEmployeeId && selectedMonth) {
      checkPayrollConfirmed();
    }
  }, [selectedEmployeeId, selectedMonth]); // eslint-disable-line react-hooks/exhaustive-deps

  // propìœ¼ë¡œ ë°›ì€ ì›”ì´ ë³€ê²½ë  ë•Œ ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
  useEffect(() => {
    if (propSelectedMonth) {
      setSelectedMonth(propSelectedMonth);
    }
  }, [propSelectedMonth]);

  // propìœ¼ë¡œ ë°›ì€ ì§ì› IDê°€ ë³€ê²½ë  ë•Œ ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
  useEffect(() => {
    if (propSelectedEmployeeId) {
      setSelectedEmployeeId(propSelectedEmployeeId);
      
      // ğŸ”¥ ì§ì› ì„ íƒ ì‹œ í•´ë‹¹ ì§ì›ì˜ ì²« ë²ˆì§¸ ì§€ì  ìë™ ì„ íƒ
      const selectedEmployee = employees.find(emp => emp.id === propSelectedEmployeeId);
      if (selectedEmployee) {
        const employeeData = selectedEmployee as Employee & { branches?: string[]; branchIds?: string[] };
        const employeeBranches = employeeData.branches || employeeData.branchIds || [];
        if (employeeBranches.length > 0) {
          setSelectedBranchId(employeeBranches[0]);
        }
      }
    }
  }, [propSelectedEmployeeId, employees]);

  // ì¼ë°˜ ì‚¬ìš©ìì˜ ê²½ìš° ìë™ìœ¼ë¡œ ì§€ì  ì„ íƒ
  useEffect(() => {
    if (!isManager && userBranch && branches.length > 0) {
      setSelectedBranchId(userBranch);
    }
  }, [isManager, userBranch, branches]);

  // ğŸ”¥ ìµœì í™”: í•„ìš”í•œ ê°’ì´ ë³€ê²½ë  ë•Œë§Œ ìŠ¤ì¼€ì¤„ ë¡œë“œ
  useEffect(() => {
    if (selectedMonth && selectedBranchId && selectedEmployeeId) {
      loadWeeklySchedules();
    }
  }, [selectedMonth, selectedBranchId, selectedEmployeeId]); // eslint-disable-line react-hooks/exhaustive-deps

  // ğŸ”¥ ìµœì í™”: ìœ„ì˜ useEffectì™€ ì¤‘ë³µ ì œê±°ë¨


  return (
    <div className="p-6 max-w-7xl mx-auto">
      <div className="mb-6">
        <h1 className="text-2xl font-bold text-gray-900 mb-2">ê¸‰ì—¬ê³„ì‚°</h1>
        <p className="text-gray-600">ì§ì›ë³„ ê¸‰ì—¬ë¥¼ ê³„ì‚°í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
      </div>

      {/* ì„ íƒëœ ì›” í‘œì‹œ */}
      {selectedMonth && (
        <div className="mb-6">
          <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div className="flex items-center">
              <div className="text-blue-600 font-medium">
                ğŸ“… ì„ íƒëœ ì›”: {selectedMonth}
              </div>
            </div>
          </div>
        </div>
      )}


      {/* ê¸‰ì—¬ê³„ì‚° ê²°ê³¼ */}
      {selectedMonth && selectedBranchId && selectedEmployeeId && (
        <div className="bg-white shadow rounded-lg overflow-hidden">
          <div className="px-6 py-4 border-b border-gray-200">
            <h3 className="text-lg font-medium text-gray-900">
              ê¸‰ì—¬ê³„ì‚° ê²°ê³¼ ({selectedMonth})
            </h3>
            <p className="text-sm text-gray-600">
              {branches.find(b => b.id === selectedBranchId)?.name} ì§€ì  - {employees.find(e => e.id === selectedEmployeeId)?.name} ì§ì›
            </p>
          </div>

          {loading ? (
            <div className="px-6 py-12 text-center">
              <div className="text-gray-500">ë¡œë”© ì¤‘...</div>
            </div>
          ) : noScheduleData ? (
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
              <div className="text-yellow-800 text-lg font-semibold mb-2">
                ğŸ“‹ ë¯¸ì²˜ë¦¬ ìƒíƒœ
              </div>
              <div className="text-yellow-700">
                ì„ íƒëœ ì§ì›ì˜ ê·¼ë¬´ì‹œê°„ ë¹„êµ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br/>
                ê¸‰ì—¬ê³„ì‚°ì„ ìœ„í•´ì„œëŠ” ë¨¼ì € ê·¼ë¬´ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.
              </div>
            </div>
          ) : payrollCalculations.length > 0 ? (
            <div className="p-6">
              {/* ì§ì› ì •ë³´ (í‘œ ë°”ê¹¥) */}
              {payrollCalculations.filter(calc => calc.employeeId === selectedEmployeeId).map((calc) => (
                <div key={calc.employeeId} className="mb-8">
                  <div className="bg-gray-50 p-4 rounded-lg mb-4">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <div>
                        <label className="text-sm font-medium text-gray-700">ì§ì›ëª…</label>
                        <p className="text-lg font-semibold text-gray-900">{calc.employeeName}</p>
                      </div>
                      <div>
                        <label className="text-sm font-medium text-gray-700">ê³ ìš©í˜•íƒœ</label>
                        <p className="text-lg font-semibold text-gray-900">{calc.employmentType}</p>
                      </div>
                      <div>
                        <label className="text-sm font-medium text-gray-700">ê¸‰ì—¬í˜•íƒœ</label>
                        <p className="text-lg font-semibold text-gray-900">{calc.salaryType}</p>
                      </div>
                      <div>
                        <label className="text-sm font-medium text-gray-700">ì‹œê¸‰/ì›”ê¸‰</label>
                        <p className="text-lg font-semibold text-gray-900">
                          {(calc.salaryType === 'ì‹œê¸‰' || calc.salaryType === 'hourly')
                            ? `${calc.hourlyWage?.toLocaleString()}ì›/ì‹œê°„`
                            : (calc.salaryType === 'ì›”ê¸‰' || calc.salaryType === 'monthly')
                            ? `${calc.monthlySalary?.toLocaleString()}ì›/ì›”`
                            : calc.salaryType}
                        </p>
                      </div>
                    </div>
                  </div>

                  {/* ì§€ì ë³„ ê·¼ë¬´ì‹œê°„ í…Œì´ë¸” */}
                  <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-gray-200">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ì§€ì 
                          </th>
                          <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ê·¼ë¬´ì‹œê°„
                          </th>
                          <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ì´ˆê³¼ê·¼ë¬´ì‹œê°„
                          </th>
                        </tr>
                      </thead>
                      <tbody className="bg-white divide-y divide-gray-200">
                        {calc.branches.map((branch, index) => (
                          <tr key={index} className="hover:bg-gray-50">
                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                              {branch.branchName}
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">
                              {branch.workHours.toFixed(1)}ì‹œê°„
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">
                              {/* ì´ˆê³¼ê·¼ë¬´ì‹œê°„ ê³„ì‚° */}
                              {(() => {
                                // ì£¼ê°„ê·¼ë¬´ì‹œê°„ (ê¸°ë³¸ê°’ 40ì‹œê°„, ì‹¤ì œë¡œëŠ” ì§ì› ì •ë³´ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
                                const weeklyWorkHours = 40;
                                // í•˜ë£¨ê·¼ë¬´ì‹œê°„ = ì£¼ê°„ê·¼ë¬´ì‹œê°„ / 8
                                const dailyWorkHours = weeklyWorkHours / 8;
                                // í•´ë‹¹ì›”ì˜ ì¼ìˆ˜
                                const monthDate = typeof selectedMonth === 'string' ? new Date(selectedMonth) : selectedMonth;
                                const daysInMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).getDate();
                                // í•œë‹¬ê·¼ë¬´ì‹œê°„ = í•˜ë£¨ê·¼ë¬´ì‹œê°„ Ã— í•´ë‹¹ì›”ì˜ ì¼ìˆ˜
                                const monthlyWorkHours = dailyWorkHours * daysInMonth;
                                // ì´ˆê³¼ê·¼ë¬´ì‹œê°„ = í•´ë‹¹ì›” ì´ ê·¼ë¬´ì‹œê°„ - í•œë‹¬ê·¼ë¬´ì‹œê°„
                                const overtimeHours = Math.max(0, branch.workHours - monthlyWorkHours);
                                return overtimeHours.toFixed(1) + 'ì‹œê°„';
                              })()}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="px-6 py-12 text-center">
              <div className="text-gray-500 text-lg mb-2">ğŸ“Š</div>
              <div className="text-gray-500 text-lg mb-2">ê¸‰ì—¬ê³„ì‚° ë°ì´í„° ì—†ìŒ</div>
              <div className="text-gray-400 text-sm">
                ì›”ê³¼ ì§€ì ì„ ì„ íƒí•˜ê³  ì£¼ê°„ ìŠ¤ì¼€ì¤„ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.
              </div>
            </div>
          )}
        </div>
      )}

      {/* í•˜ë‹¨ ê³„ì‚°ë‚´ì—­ */}
      {payrollCalculations.length > 0 && (
        <div className="mt-6 bg-white shadow rounded-lg p-6">
          <h3 className="text-lg font-medium text-gray-900 mb-4">ìƒì„¸ ê³„ì‚° ë‚´ì—­</h3>
          {payrollCalculations.filter(calc => calc.employeeId === selectedEmployeeId).map((calc) => (
            <div key={calc.employeeId} className="mb-6 pb-6 border-b border-gray-200 last:border-b-0 last:mb-0 last:pb-0">
              {/* ê¸°ë³¸ ì •ë³´ í…Œì´ë¸” */}
              <div className="overflow-x-auto mb-4">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ì§ì›ëª…</th>
                      <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ê³ ìš©í˜•íƒœ</th>
                      <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ê¸‰ì—¬í˜•íƒœ</th>
                      <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ì‹œê¸‰/ì›”ê¸‰</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    <tr>
                      <td className="px-4 py-2 text-sm font-medium text-gray-900">{calc.employeeName}</td>
                      <td className="px-4 py-2 text-sm text-gray-700">{calc.employmentType}</td>
                      <td className="px-4 py-2 text-sm text-gray-700">{calc.salaryType}</td>
                      <td className="px-4 py-2 text-sm text-gray-700">
                        {(calc.salaryType === 'ì‹œê¸‰' || calc.salaryType === 'hourly')
                          ? `${calc.hourlyWage?.toLocaleString()}ì›/ì‹œê°„`
                          : (calc.salaryType === 'ì›”ê¸‰' || calc.salaryType === 'monthly')
                          ? `${calc.monthlySalary?.toLocaleString()}ì›/ì›”`
                          : '-'}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              {/* ê·¼ë¬´ì‹œê°„ í…Œì´ë¸” */}
              <div className="overflow-x-auto mb-4">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ì‹¤ ê·¼ë¬´ì‹œê°„</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    <tr>
                      <td className="px-4 py-2 text-sm text-gray-900">{calc.actualWorkHours.toFixed(1)}ì‹œê°„</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              {/* ì£¼íœ´ìˆ˜ë‹¹ ìƒì„¸ */}
              {calc.weeklyHolidayDetails && calc.weeklyHolidayDetails.length > 0 && (
                <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
                  <p className="text-blue-800 font-semibold mb-2">ğŸ“… ì£¼ì°¨ë³„ ì£¼íœ´ìˆ˜ë‹¹ ê³„ì‚° ë‚´ì—­:</p>
                  <div className="space-y-1 text-xs">
                    {/* ğŸ”¥ ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬ */}
                    {[...calc.weeklyHolidayDetails].sort((a, b) => {
                      const dateA = new Date(a.weekStart);
                      const dateB = new Date(b.weekStart);
                      return dateA.getTime() - dateB.getTime();
                    }).map((detail, idx) => (
                      <div key={idx} className={`flex justify-between ${detail.eligible ? 'text-blue-700' : 'text-gray-500'}`}>
                        <span>{detail.weekStart} ~ {detail.weekEnd}:</span>
                        <span>
                          {detail.eligible ? (
                            <>{detail.hours.toFixed(1)}ì‹œê°„ Ã— {calc.hourlyWage?.toLocaleString()}ì› = {detail.pay.toLocaleString()}ì›</>
                          ) : (
                            <span className="text-red-600">{detail.reason}</span>
                          )}
                        </span>
                      </div>
                    ))}
                    <div className="pt-2 mt-2 border-t border-blue-300 flex justify-between font-semibold text-blue-800">
                      <span>ì£¼íœ´ìˆ˜ë‹¹ í•©ê³„:</span>
                      <span>{calc.weeklyHolidayPay?.toLocaleString()}ì› ({calc.weeklyHolidayHours?.toFixed(1)}ì‹œê°„)</span>
                    </div>
                  </div>
                </div>
              )}

              {/* ë¬´ê¸‰íœ´ê°€ ì…ë ¥ (ê·¼ë¡œì†Œë“ì+ì›”ê¸‰ì œë§Œ) */}
              {calc.employmentType === 'ê·¼ë¡œì†Œë“' && calc.salaryType === 'ì›”ê¸‰' && (
                <div className="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                  <h4 className="text-sm font-medium text-yellow-800 mb-2">ë¬´ê¸‰íœ´ê°€ ê´€ë¦¬</h4>
                  <div className="flex items-center space-x-4">
                    <div>
                      <label className="block text-xs text-yellow-700 mb-1">ë¬´ê¸‰íœ´ê°€ ì¼ìˆ˜</label>
                      <input
                        type="number"
                        min="0"
                        max="30"
                        value={calc.unpaidLeaveDays || 0}
                        onChange={(e) => {
                          const days = parseInt(e.target.value) || 0;
                          // TODO: ë¬´ê¸‰íœ´ê°€ ì¼ìˆ˜ ë³€ê²½ ì‹œ ì¬ê³„ì‚° ë¡œì§ ì¶”ê°€
                          console.log('ë¬´ê¸‰íœ´ê°€ ì¼ìˆ˜ ë³€ê²½:', days);
                        }}
                        className="w-20 px-2 py-1 border border-yellow-300 rounded focus:outline-none focus:ring-2 focus:ring-yellow-500 text-sm"
                      />
                    </div>
                    <div>
                      <label className="block text-xs text-yellow-700 mb-1">ì°¨ê°ì•¡</label>
                      <span className="text-sm font-medium text-yellow-800">
                        {calc.unpaidLeaveDeduction ? calc.unpaidLeaveDeduction.toLocaleString() + 'ì›' : '0ì›'}
                      </span>
                    </div>
                    <div className="text-xs text-yellow-600">
                      * ì›”ê¸‰ ê¸°ì¤€ìœ¼ë¡œ ì¼í•  ê³„ì‚°ë©ë‹ˆë‹¤ (ì›”ê¸‰ Ã· 30ì¼)
                    </div>
                  </div>
                </div>
              )}

              {/* ê¸‰ì—¬ ë° ê³µì œ í…Œì´ë¸” */}
              <div className="overflow-x-auto mb-4">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ê¸°ë³¸ê¸‰</th>
                      {/* ì‹œê¸‰ì¼ ë•Œë§Œ ì£¼íœ´ìˆ˜ë‹¹ ì»¬ëŸ¼ í‘œì‹œ */}
                      {calc.salaryType === 'ì‹œê¸‰' && (
                        <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ì£¼íœ´ìˆ˜ë‹¹</th>
                      )}
                      <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                        {calc.employmentType === 'ê·¼ë¡œì†Œë“' ? '4ëŒ€ë³´í—˜' : 'ì‚¬ì—…ì†Œë“ê³µì œ'}
                      </th>
                      <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ì´ ê³µì œì•¡</th>
                      <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase bg-blue-50">ì‹¤ìˆ˜ë ¹ì•¡</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    <tr>
                      <td className="px-4 py-2 text-sm text-gray-900">
                        {calc.salaryType === 'ì‹œê¸‰' 
                          ? (calc.grossPay - (calc.weeklyHolidayPay || 0)).toLocaleString() + 'ì›'
                          : calc.grossPay.toLocaleString() + 'ì›'
                        }
                      </td>
                      {/* ì‹œê¸‰ì¼ ë•Œë§Œ ì£¼íœ´ìˆ˜ë‹¹ ì…€ í‘œì‹œ */}
                      {calc.salaryType === 'ì‹œê¸‰' && (
                        <td className="px-4 py-2 text-sm text-gray-900">
                          {calc.weeklyHolidayPay ? calc.weeklyHolidayPay.toLocaleString() + 'ì›' : '-'}
                        </td>
                      )}
                      <td className="px-4 py-2 text-sm text-gray-900">
                        {calc.employmentType === 'ê·¼ë¡œì†Œë“' && calc.deductions.insuranceDetails ? (
                          <div className="text-xs">
                            <div>êµ­ë¯¼ì—°ê¸ˆ: {calc.deductions.insuranceDetails.nationalPension.toLocaleString()}ì›</div>
                            <div>ê±´ê°•ë³´í—˜: {calc.deductions.insuranceDetails.healthInsurance.toLocaleString()}ì›</div>
                            <div>ì¥ê¸°ìš”ì–‘: {calc.deductions.insuranceDetails.longTermCare.toLocaleString()}ì›</div>
                            <div>ê³ ìš©ë³´í—˜: {calc.deductions.insuranceDetails.employmentInsurance.toLocaleString()}ì›</div>
                            <div className="font-medium pt-1 border-t">
                              í•©ê³„: {calc.deductions.insurance.toLocaleString()}ì›
                            </div>
                          </div>
                        ) : calc.employmentType === 'ê·¼ë¡œì†Œë“' ? (
                          calc.deductions.insurance > 0 ? calc.deductions.insurance.toLocaleString() + 'ì›' : '-'
                        ) : (
                          calc.deductions.tax > 0 ? calc.deductions.tax.toLocaleString() + 'ì›' : '-'
                        )}
                      </td>
                      <td className="px-4 py-2 text-sm text-red-600">{calc.deductions.total.toLocaleString()}ì›</td>
                      <td className="px-4 py-2 text-sm font-bold text-blue-700 bg-blue-50">{calc.netPay.toLocaleString()}ì›</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              {/* ê¸‰ì—¬í™•ì •/ì·¨ì†Œ ë²„íŠ¼ */}
              <div className="mt-4 pt-4 border-t border-gray-200">
                {isPayrollConfirmed ? (
                  <button
                    onClick={cancelConfirmPayroll}
                    disabled={confirming}
                    className="w-full bg-red-600 hover:bg-red-700 disabled:bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200"
                  >
                    {confirming ? 'ì²˜ë¦¬ ì¤‘...' : 'ê¸‰ì—¬í™•ì • ì·¨ì†Œ'}
                  </button>
                ) : (
                  <>
                    <button
                      onClick={() => confirmPayroll(calc)}
                      disabled={confirming}
                      className="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200"
                    >
                      {confirming ? 'í™•ì • ì¤‘...' : 'ê¸‰ì—¬í™•ì •'}
                    </button>
                    <p className="text-xs text-gray-500 mt-2 text-center">
                      âš ï¸ ê¸‰ì—¬í™•ì • í›„ì—ëŠ” ë°ì´í„°ê°€ ë³€ê²½ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤
                    </p>
                  </>
                )}
              </div>
            </div>
          ))}
          
          {/* ìˆ˜ìŠµê¸°ê°„ë³„ ìƒì„¸ ê³„ì‚° ë‚´ì—­ */}
          {payrollCalculations.filter(calc => calc.employeeId === selectedEmployeeId).map((calc) => (
            <div key={`probation-${calc.employeeId}`}>
              {(calc.probationHours || 0) > 0 && (
                <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                  <h4 className="text-md font-semibold text-red-800 mb-3">â–² ìˆ˜ìŠµê¸°ê°„ ì‹¤ì œ ê·¼ë¬´ì‹œê°„ ê³„ì‚° (ì‹œê¸‰):</h4>
                  <div className="space-y-2 text-sm">
                    <div className="flex justify-between">
                      <span className="text-red-700">ìˆ˜ìŠµê¸°ê°„ ê·¼ë¬´ì‹œê°„:</span>
                      <span className="font-semibold text-red-800">{calc.probationHours}ì‹œê°„ (90% ì§€ê¸‰)</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-red-700">ì •ê·œê¸°ê°„ ê·¼ë¬´ì‹œê°„:</span>
                      <span className="font-semibold text-red-800">{calc.regularHours}ì‹œê°„ (100% ì§€ê¸‰)</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-red-700">ìˆ˜ìŠµê¸°ê°„ ê¸‰ì—¬:</span>
                      <span className="font-semibold text-red-800">{calc.probationPay?.toLocaleString()}ì›</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-red-700">ì •ê·œê¸°ê°„ ê¸‰ì—¬:</span>
                      <span className="font-semibold text-red-800">{calc.regularPay?.toLocaleString()}ì›</span>
                    </div>
                    <div className="mt-2 pt-2 border-t border-red-300">
                      <div className="text-xs text-red-600">
                        ê³„ì‚°ì‹: ({calc.probationHours} Ã— {calc.hourlyWage?.toLocaleString()} Ã— 0.9) + ({calc.regularHours} Ã— {calc.hourlyWage?.toLocaleString()}) = {((calc.probationPay || 0) + (calc.regularPay || 0)).toLocaleString()}ì›
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          ))}
        </div>
      )}

      {/* ê¸‰ì—¬ë©”ëª¨ í¸ì§‘ */}
      {selectedMonth && selectedEmployeeId && (
        <div className="mt-6 bg-white shadow rounded-lg">
          <div className="px-6 py-4 border-t border-gray-200 bg-gray-50">
            <div className="flex items-start space-x-3">
              <div className="flex-shrink-0">
                <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                  <span className="text-blue-600 text-sm">ğŸ“</span>
                </div>
              </div>
              <div className="flex-1">
                <h4 className="text-sm font-medium text-gray-900 mb-2">ê¸‰ì—¬ë©”ëª¨ (ìë™ì €ì¥)</h4>
                <textarea
                  value={employeeMemos[selectedEmployeeId] || ''}
                  onChange={(e) => {
                    const memo = e.target.value;
                    setMemo(memo);
                    setEmployeeMemos(prev => ({
                      ...prev,
                      [selectedEmployeeId]: memo
                    }));
                  }}
                  onBlur={(e) => {
                    // í¬ì»¤ìŠ¤ë¥¼ ìƒì„ ë•Œ ì €ì¥ (í•œê¸€ ì…ë ¥ ì™„ë£Œ í›„)
                    const memo = e.target.value;
                    setMemo(memo);
                    saveMemo();
                  }}
                  placeholder="ì´ë²ˆ ë‹¬ ê¸‰ì—¬ì— ëŒ€í•œ íŠ¹ì´ì‚¬í•­ì´ë‚˜ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                  rows={3}
                />
              </div>
            </div>
          </div>
        </div>
      )}

      {/* ìš”ì•½ í†µê³„ */}
      {payrollCalculations.length > 0 && (
        <div className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="bg-green-50 p-4 rounded-lg">
            <div className="text-2xl font-bold text-green-600">
              {payrollCalculations.reduce((sum, calc) => sum + calc.actualWorkHours, 0).toFixed(1)}ì‹œê°„
            </div>
            <div className="text-sm text-green-600">ì´ ì‹¤ì œê·¼ë¬´ì‹œê°„</div>
          </div>
          <div className="bg-yellow-50 p-4 rounded-lg">
            <div className="text-2xl font-bold text-yellow-600">
              {payrollCalculations.reduce((sum, calc) => sum + calc.grossPay, 0).toLocaleString()}ì›
            </div>
            <div className="text-sm text-yellow-600">ì´ ê¸°ë³¸ê¸‰</div>
          </div>
          <div className="bg-purple-50 p-4 rounded-lg">
            <div className="text-2xl font-bold text-purple-600">
              {payrollCalculations.reduce((sum, calc) => sum + calc.netPay, 0).toLocaleString()}ì›
            </div>
            <div className="text-sm text-purple-600">ì´ ì‹¤ìˆ˜ë ¹ì•¡</div>
          </div>
        </div>
      )}
    </div>
  );
};

export default PayrollCalculation;